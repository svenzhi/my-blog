import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as s,b as i,o as t}from"./app-B-KrpRMf.js";const n="/assets/FBFLDDFBFFLHLH-2-BGUtwTdv.png",o="/assets/FBFLDDFBFFLHLH-3-CuhwiG98.png",c="/assets/FBFLDDFBFFLHLH-4-L9hPBWbX.png",l="/assets/FBFLDDFBFFLHLH-5-j3nXijEA.png",p="/assets/FBFLDDFBFFLHLH-6-BiyvvJLQ.png",r="/assets/FBFLDDFBFFLHLH-7-D87G2eZc.png",d="/assets/FBFLDDFBFFLHLH-8-uC_ig9pX.png",u="/assets/FBFLDDFBFFLHLH-9-O15WcrsJ.png",h="/assets/FBFLDDFBFFLHLH-10-CkGy9OpY.png",g="/assets/FBFLDDFBFFLHLH-13-7vr0YXrk.png",b="/assets/FBFLDDFBFFLHLH-15-DA7ANwFE.png",m="/assets/FBFLDDFBFFLHLH-19-BBMRIkGy.png",q="/assets/FBFLDDFBFFLHLH-20-DKPvhpby.png",f="/assets/FBFLDDFBFFLHLH-21-DE7z0C3N.png",k={};function v(F,e){return t(),s("div",null,[...e[0]||(e[0]=[i(`<h2 id="_1-需求梳理" tabindex="-1"><a class="header-anchor" href="#_1-需求梳理"><span>1.需求梳理</span></a></h2><blockquote><p>博主有一个简易文件存储站点，用来作图床与公开文件存放，但碍于服务器带宽限制，外链大文件加载速度属实不佳，刚好最近阿里云ESA有征文试用活动，便决定把该站点解析到阿里云ESA试试效果如何。<br> 本文参与「玩透 ESA」有奖征文活动，活动详情见：<a href="http://event.alibabacloud-esa.com/" target="_blank" rel="noopener noreferrer">http://event.alibabacloud-esa.com/</a></p></blockquote><p>大致有如下需求：</p><ol><li>全站存储外链文件、全站前端引用资源（如js、css、图片），需要缓存；</li><li>特定页面不缓存（文件列表页等动态加载页面）；</li><li>存在特定<code>cookie</code>、<code>session</code>时不缓存；</li><li>特定引用资源不缓存（如流量统计js）；</li><li>特定路径的外链文件不缓存（如用来作其它服务远程配置的外链文件）</li></ol><blockquote><p>二次整理需求，主要明确缓存白名单，让缓存规则更简单，也更保守。<br> 这一步可参考<a href="https://help.aliyun.com/zh/edge-security-acceleration/esa/user-guide/default-cache-rule" target="_blank" rel="noopener noreferrer">默认缓存策略和缓存生效逻辑-边缘安全加速(ESA)-阿里云帮助中心</a></p></blockquote><p><strong>缓存白名单：</strong></p><ol><li>上传的外链文件分为<code>/cdn/</code>和<code>/no/</code>（<code>no-cache</code>或<code>no-cdn</code>）两个目录，仅对<code>/cdn/</code>目录下上传的指定后缀文件进行缓存（如<code>.jpg</code>、<code>.pdf</code>、<code>.zip</code>等）；</li><li>站点自身引用的静态资源，进行缓存，如<code>.js</code>、<code>.css</code>；</li></ol><p><strong>不缓存内容（黑名单）:</strong></p><ol><li>全站页面路径（即无后缀路径），默认不缓存（站点页面都是动态PHP展示文件列表）；</li><li>存在特定<code>cookie</code>、<code>session</code>时不缓存；</li><li>自定义指定路径资源，不缓存（如指定路径、扩展文件、资源、流量统计js等）；</li></ol><p>这样缓存配置就比较简单了，可以先只配置缓存白名单和存在指定<code>cookie</code>、<code>session</code>是不缓存。</p><p><strong>AI总结</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>采用“静态资源缓存白名单 + 特定路径排除”策略：</span></span>
<span class="line"><span>只有明确允许的文件后缀会被缓存，其余全部不缓存；同时对于白名单中的某些路径或具体文件仍然可以排除，以确保动态页面、后台内容与敏感资源不缓存。</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if path matches SpecialExcludePath:</span></span>
<span class="line"><span>    no-cache</span></span>
<span class="line"><span>else if extension in Blacklist:</span></span>
<span class="line"><span>    no-cache</span></span>
<span class="line"><span>else if has login cookie:</span></span>
<span class="line"><span>    no-cache</span></span>
<span class="line"><span>else if no extension:</span></span>
<span class="line"><span>    no-cache</span></span>
<span class="line"><span>else if extension in Whitelist:</span></span>
<span class="line"><span>    cache</span></span>
<span class="line"><span>else:</span></span>
<span class="line"><span>    no-cache   # fallback</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>后期黑名单可进一步扩展如下内容</span></span>
<span class="line"><span>php cgi pl py rb</span></span>
<span class="line"><span>json xml txt</span></span>
<span class="line"><span>api action do</span></span>
<span class="line"><span>asp aspx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-esa接入" tabindex="-1"><a class="header-anchor" href="#_2-esa接入"><span>2.ESA接入</span></a></h2><h3 id="站点添加" tabindex="-1"><a class="header-anchor" href="#站点添加"><span>站点添加</span></a></h3><p>ESA站点添加支持CNAME、NS两种方式，同时支持国内、全球加速，较为简单，这里跳过。</p><figure><img src="`+n+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="dns解析" tabindex="-1"><a class="header-anchor" href="#dns解析"><span>DNS解析</span></a></h3><blockquote><p>1.在ESA站点管理-DNS记录中找到添加记录；<br><img src="'+o+'" alt="" loading="lazy"></p></blockquote><blockquote><p>2.进入添加记录页面后，按提示填写；</p></blockquote><figure><img src="'+c+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><blockquote><p>3.选择站点类型，由于我这个外链站除了有文件外链、下载功能外，还有动态页面以及文件访问统计等API，所以选择了<code>网站页面</code>而非<code>图片视频</code>类型的纯静态类型；<br><img src="'+l+'" alt="" loading="lazy"></p></blockquote><blockquote><p>4.由于我的站点是CNAME接入的，所以还需要去解析验证，按提示操作即可。<br><img src="'+p+'" alt="" loading="lazy"></p></blockquote><h3 id="配置ssl证书" tabindex="-1"><a class="header-anchor" href="#配置ssl证书"><span>配置SSL证书</span></a></h3><blockquote><p>ESA提供了Let’s Encrypt、Digicert免费证书，这里我们申请Let’s Encrypt证书；</p></blockquote><figure><img src="'+r+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><blockquote><p>同样是证书申请页面下发，建议开启强制 HTTPS<br><img src="'+d+'" alt="" loading="lazy"></p></blockquote><h2 id="_3-缓存配置" tabindex="-1"><a class="header-anchor" href="#_3-缓存配置"><span>3.缓存配置</span></a></h2><blockquote><p>接下来回到文章开头提及的缓存需求，并进行配置。</p></blockquote><h3 id="仅缓存指定路径-后缀" tabindex="-1"><a class="header-anchor" href="#仅缓存指定路径-后缀"><span>仅缓存指定路径+后缀</span></a></h3><blockquote><p>这里我们要缓存/cdn/目录下的内容，当然这里后缀名并不完善，只是写了我可能用到的。<br> 表达式如下，注意这里的<code>www.example.com</code>要更换成你自己的。<br> 常见后缀名也可以参考阿里云文档：<br><a href="https://help.aliyun.com/zh/edge-security-acceleration/esa/user-guide/default-cache-rule" target="_blank" rel="noopener noreferrer">默认缓存策略和缓存生效逻辑-边缘安全加速(ESA)-阿里云帮助中心</a></p></blockquote><figure><img src="'+u+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>(http.host in {&quot;www.example.com&quot;} and starts_with(http.request.uri, &quot;/cdn&quot;) and lower(http.request.uri.path.extension) in {&quot;doc&quot; &quot;docx&quot; &quot;ppt&quot; &quot;pptx&quot; &quot;pdf&quot; &quot;csv&quot; &quot;bmp&quot; &quot;gif&quot; &quot;ico&quot; &quot;jpeg&quot; &quot;jpg&quot; &quot;svg&quot; &quot;svgz&quot; &quot;tif&quot; &quot;tiff&quot; &quot;webp&quot; &quot;mp3&quot; &quot;flac&quot; &quot;mid&quot; &quot;midi&quot; &quot;avi&quot; &quot;mp4&quot; &quot;mkv&quot; &quot;webm&quot; &quot;7z&quot; &quot;gz&quot; &quot;rar&quot; &quot;tar&quot; &quot;zip&quot; &quot;zst&quot;})</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="'+h+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="设置默认不缓存路径" tabindex="-1"><a class="header-anchor" href="#设置默认不缓存路径"><span>设置默认不缓存路径</span></a></h3><blockquote><p>由于在缓存需求梳理那里，规则设置较为粗暴，所以这里直接设置开头不为<code>/cdn</code>的均不缓存；</p></blockquote><figure><img src="'+g+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="设置存在指定cookie、session时不缓存" tabindex="-1"><a class="header-anchor" href="#设置存在指定cookie、session时不缓存"><span>设置存在指定<code>cookie</code>、<code>session</code>时不缓存</span></a></h3><blockquote><p>表达式如下，注意这里的<code>www.example.com</code>要更换成你自己的。</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>(http.host in {&quot;www.example.com&quot;} and lower(http.cookie) contains &quot;admin_session&quot;) or (http.host in {&quot;www.example.com&quot;} and lower(http.cookie) contains &quot;dir_passwd&quot;) or (http.host in {&quot;www.example.com&quot;} and lower(http.cookie) contains &quot;PHPSESSID&quot;)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="'+b+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_4-缓存测试" tabindex="-1"><a class="header-anchor" href="#_4-缓存测试"><span>4.缓存测试</span></a></h2><blockquote><p>分别查看缓存目录和不缓存目录下的文件，可以看到ESA的返回头差异。</p></blockquote><blockquote><p>在缓存文件的响应头中可以看到，<code>x-site-cache-status</code>为命中缓存，<code>x-swift-cachetime=864000秒</code>正是设置的缓存有效期10天。</p></blockquote><figure><img src="'+m+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><blockquote><p>非缓存文件则可以看到<code>x-site-cache-status=DYNAMIC</code></p></blockquote><figure><img src="'+q+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_5-站点测速" tabindex="-1"><a class="header-anchor" href="#_5-站点测速"><span>5.站点测速</span></a></h2><figure><img src="'+f+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>本篇文章记录了将个人外链文件站点接入阿里云 ESA（Edge Security Acceleration）的完整过程，并重点介绍如何基于“缓存白名单 + 路径排除”策略实现精细化缓存控制。站点的主要诉求是在带宽受限的情况下提升大文件外链、前端静态资源加载速度，同时保证动态页面、后台管理与敏感资源不被缓存。</p><p>文中首先梳理了缓存需求，通过将上传文件区分为 <code>/cdn/</code> 与 <code>/no/</code> 目录，仅对白名单中的静态资源与特定后缀文件启用缓存；同时针对无后缀路径、存在特定 cookie/session、统计脚本等内容进行全局排除。随后介绍了 ESA 的站点接入、DNS 解析、SSL 证书配置流程，并给出了可直接使用的缓存表达式示例。</p><p>最后通过响应头验证缓存命中情况，并展示接入 ESA 后的加速效果。整体方案简单、可控、安全，适合中小型文件站点快速获得显著的访问加速体验。</p>',53)])])}const _=a(k,[["render",v]]),L=JSON.parse('{"path":"/posts/daily/alibaba-cloud-esa-custom-cache-rules.html","title":"「玩透ESA」站点配置阿里云ESA全站加速+自定义规则缓存","lang":"zh-CN","frontmatter":{"author":null,"title":"「玩透ESA」站点配置阿里云ESA全站加速+自定义规则缓存","date":"2025-11-20T00:00:00.000Z","icon":null,"cover":null,"order":null,"category":["daily"],"tags":["阿里云ESA","CDN","Cache缓存"],"footer":null,"copyright":null,"sticky":false,"star":false,"uid":"FBFLDDFBFFLHLH","imageNameKey":"FBFLDDFBFFLHLH","description":"1.需求梳理 博主有一个简易文件存储站点，用来作图床与公开文件存放，但碍于服务器带宽限制，外链大文件加载速度属实不佳，刚好最近阿里云ESA有征文试用活动，便决定把该站点解析到阿里云ESA试试效果如何。 本文参与「玩透 ESA」有奖征文活动，活动详情见：http://event.alibabacloud-esa.com/ 大致有如下需求： 全站存储外链文...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"「玩透ESA」站点配置阿里云ESA全站加速+自定义规则缓存\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-11-20T00:00:00.000Z\\",\\"dateModified\\":\\"2025-11-23T14:00:41.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"itsven\\",\\"url\\":\\"https://blog.itsven.cn\\"}]}"],["meta",{"property":"og:url","content":"https://blog.itsven.cn/posts/daily/alibaba-cloud-esa-custom-cache-rules.html"}],["meta",{"property":"og:site_name","content":"itsven"}],["meta",{"property":"og:title","content":"「玩透ESA」站点配置阿里云ESA全站加速+自定义规则缓存"}],["meta",{"property":"og:description","content":"1.需求梳理 博主有一个简易文件存储站点，用来作图床与公开文件存放，但碍于服务器带宽限制，外链大文件加载速度属实不佳，刚好最近阿里云ESA有征文试用活动，便决定把该站点解析到阿里云ESA试试效果如何。 本文参与「玩透 ESA」有奖征文活动，活动详情见：http://event.alibabacloud-esa.com/ 大致有如下需求： 全站存储外链文..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-11-23T14:00:41.000Z"}],["meta",{"property":"article:tag","content":"Cache缓存"}],["meta",{"property":"article:tag","content":"CDN"}],["meta",{"property":"article:tag","content":"阿里云ESA"}],["meta",{"property":"article:published_time","content":"2025-11-20T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-11-23T14:00:41.000Z"}]]},"git":{"createdTime":1763906441000,"updatedTime":1763906441000,"contributors":[{"name":"svenzhi","username":"svenzhi","email":"svenzhi@163.com","commits":1,"url":"https://github.com/svenzhi"}],"changelog":[{"hash":"43b3f7659ab0a39f3befc6a3fe730e34151fd927","time":1763906441000,"email":"svenzhi@163.com","author":"svenzhi","message":"新增文章：阿里云ESA配置全站加速+自定义缓存"}]},"readingTime":{"minutes":5.27,"words":1581},"filePathRelative":"posts/daily/alibaba-cloud-esa-custom-cache-rules.md","excerpt":"<h2>1.需求梳理</h2>\\n<blockquote>\\n<p>博主有一个简易文件存储站点，用来作图床与公开文件存放，但碍于服务器带宽限制，外链大文件加载速度属实不佳，刚好最近阿里云ESA有征文试用活动，便决定把该站点解析到阿里云ESA试试效果如何。<br>\\n本文参与「玩透 ESA」有奖征文活动，活动详情见：<a href=\\"http://event.alibabacloud-esa.com/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">http://event.alibabacloud-esa.com/</a></p>\\n</blockquote>\\n<p>大致有如下需求：</p>","autoDesc":true}');export{_ as comp,L as data};
